<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Marwan Sadek - Investment Portfolio</title>
    <style>
        :root {
            --bg-primary: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            --bg-card: rgba(30, 41, 59, 0.7);
            --bg-input: rgba(51, 65, 85, 0.5);
            --border-color: rgba(255, 255, 255, 0.1);
            --text-primary: white;
            --text-secondary: #94a3b8;
            --text-tertiary: #64748b;
        }
        
        [data-theme="light"] {
            --bg-primary: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 50%, #f1f5f9 100%);
            --bg-card: rgba(255, 255, 255, 0.9);
            --bg-input: rgba(241, 245, 249, 0.8);
            --border-color: rgba(0, 0, 0, 0.1);
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-tertiary: #64748b;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            background-attachment: fixed;
            color: var(--text-primary);
            min-height: 100vh;
            padding: 10px;
            transition: all 0.3s ease;
        }
        
        .container { max-width: 1400px; margin: 0 auto; }
        
        .glass {
            background: var(--bg-card);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        
        .header {
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .header-left h1 {
            font-size: clamp(20px, 5vw, 34px);
            margin-bottom: 5px;
            font-weight: 700;
            background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .header-left .date-time {
            color: var(--text-secondary);
            font-size: clamp(11px, 2.5vw, 14px);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .live-clock {
            font-family: 'Courier New', monospace;
            font-weight: 600;
            color: #60a5fa;
        }
        
        .market-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .market-status.open { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .market-status.closed { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        
        .market-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .market-status.open .market-dot { background: #10b981; }
        .market-status.closed .market-dot { background: #ef4444; }
        
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        .header-right { 
            display: flex; 
            gap: 8px; 
            align-items: center;
        }
        
        .icon-button {
            padding: 10px;
            background: rgba(99, 102, 241, 0.2);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 10px;
            color: #a5b4fc;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
            min-height: 40px;
        }
        
        .icon-button:hover {
            background: rgba(99, 102, 241, 0.3);
            transform: translateY(-2px);
        }
        
        .icon-button.active {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }
        
        .icon-button svg {
            width: 20px;
            height: 20px;
        }
        
        .blurred .sensitive { filter: blur(8px); user-select: none; }
        
        /* Market Indices Window */
        .market-indices {
            padding: 18px;
            border-radius: 16px;
            margin-bottom: 20px;
        }
        
        .indices-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .indices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 12px;
        }
        
        .index-item {
            padding: 14px;
            background: var(--bg-input);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            transition: all 0.3s;
        }
        
        .index-item:hover {
            transform: translateY(-2px);
            border-color: rgba(96, 165, 250, 0.3);
        }
        
        .index-label {
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 6px;
        }
        
        .index-value {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .index-value.gold { color: #F59E0B; }
        .index-value.egypt-gold { color: #FB923C; }
        .index-value.egx { color: #3B82F6; }
        
        .index-change {
            font-size: 12px;
            font-weight: 600;
        }
        
        .index-change.positive { color: #10b981; }
        .index-change.negative { color: #ef4444; }
        .index-change.neutral { color: var(--text-secondary); }
        
        .index-source {
            font-size: 10px;
            color: var(--text-tertiary);
            margin-top: 4px;
            font-style: italic;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .metric-card {
            padding: 20px;
            border-radius: 14px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, rgba(96, 165, 250, 0.5), transparent);
        }
        
        .metric-card:hover {
            transform: translateY(-3px);
        }
        
        .metric-label {
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .metric-value {
            font-size: clamp(22px, 4vw, 32px);
            font-weight: 700;
        }
        
        .metric-value.positive { color: #10b981; }
        .metric-value.negative { color: #ef4444; }
        
        .tabs {
            display: flex;
            gap: 6px;
            padding: 6px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .tabs::-webkit-scrollbar { display: none; }
        .tabs { scrollbar-width: none; }
        
        .tab {
            flex: 1;
            min-width: 90px;
            padding: 12px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .tab:hover { background: rgba(51, 65, 85, 0.5); color: var(--text-primary); }
        .tab.active { background: rgba(37, 99, 235, 0.8); color: white; }
        
        .content { display: none; }
        .content.active { display: block; }
        
        .card {
            padding: 20px;
            border-radius: 14px;
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
        }
        
        .card h2 {
            font-size: clamp(17px, 3vw, 22px);
            margin-bottom: 18px;
            font-weight: 700;
        }
        
        .chart-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            min-height: 300px;
        }
        
        .pie-chart-wrapper {
            position: relative;
            width: min(280px, 90vw);
            height: min(280px, 90vw);
            margin-bottom: 25px;
        }
        
        #pieChart { cursor: pointer; transition: all 0.3s; }
        
        .pie-legend {
            width: 100%;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 10px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: var(--bg-input);
            border-radius: 10px;
            border: 1px solid var(--border-color);
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .legend-item:hover {
            background: rgba(51, 65, 85, 0.6);
            border: 1px solid rgba(96, 165, 250, 0.3);
            transform: translateX(3px);
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            flex-shrink: 0;
        }
        
        .legend-info {
            flex: 1;
            min-width: 0;
        }
        
        .legend-name {
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 2px;
        }
        
        .legend-percent {
            color: var(--text-secondary);
            font-size: 12px;
        }
        
        .legend-value {
            font-weight: 700;
            font-size: 14px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        th {
            color: var(--text-secondary);
            font-weight: 700;
            font-size: 11px;
            text-transform: uppercase;
        }
        
        tr:hover { background: rgba(51, 65, 85, 0.3); }
        .text-right { text-align: right; }
        .positive { color: #10b981; font-weight: 600; }
        .negative { color: #ef4444; font-weight: 600; }
        
        .delete-btn {
            padding: 6px 12px;
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 6px;
            color: #ef4444;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .delete-btn:hover {
            background: rgba(239, 68, 68, 0.3);
            transform: scale(1.05);
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 14px;
            margin-bottom: 18px;
        }
        
        label {
            display: block;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 6px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        textarea { min-height: 80px; resize: vertical; }
        
        .button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .button:hover { 
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }
        
        .button.secondary { 
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .button.secondary:hover {
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }
        
        .sidebar-layout {
            display: grid;
            grid-template-columns: 1fr 340px;
            gap: 20px;
        }
        
        .health-card {
            padding: 22px;
            border-radius: 14px;
            border: 1px solid var(--border-color);
            height: fit-content;
            position: sticky;
            top: 20px;
        }
        
        .health-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 14px;
        }
        
        .health-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .health-icon.low { background: rgba(16, 185, 129, 0.15); }
        .health-icon.moderate { background: rgba(245, 158, 11, 0.15); }
        .health-icon.high { background: rgba(239, 68, 68, 0.15); }
        
        .health-badge {
            padding: 6px 14px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 12px;
        }
        
        .health-badge.low { background: rgba(16, 185, 129, 0.15); color: #10b981; }
        .health-badge.moderate { background: rgba(245, 158, 11, 0.15); color: #f59e0b; }
        .health-badge.high { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
        
        .health-text h3 { 
            font-size: 18px; 
            font-weight: 700; 
            margin-bottom: 8px; 
        }
        
        .health-text p { 
            color: var(--text-secondary); 
            font-size: 13px; 
            line-height: 1.5; 
        }
        
        /* Asset Grid */
        .asset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 14px;
        }
        
        .asset-card {
            padding: 20px;
            border-radius: 14px;
            border: 1px solid var(--border-color);
            position: relative;
            transition: all 0.3s;
        }
        
        .asset-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            border-radius: 14px 14px 0 0;
        }
        
        .asset-card.gold::before { background: linear-gradient(90deg, transparent, #F59E0B, transparent); }
        .asset-card.green::before { background: linear-gradient(90deg, transparent, #10B981, transparent); }
        .asset-card.blue::before { background: linear-gradient(90deg, transparent, #3B82F6, transparent); }
        
        .asset-card:hover { transform: translateY(-3px); }
        
        .asset-card h3 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .remove-asset-btn {
            padding: 4px 10px;
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 6px;
            color: #ef4444;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .remove-asset-btn:hover {
            background: rgba(239, 68, 68, 0.3);
        }
        
        .asset-info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .asset-info-row label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin: 0;
        }
        
        .asset-info-row .value {
            font-size: 15px;
            font-weight: 700;
        }
        
        .gain-box {
            padding: 14px;
            border-radius: 10px;
            margin-top: 14px;
        }
        
        .gain-box.profit { 
            background: rgba(16, 185, 129, 0.1); 
            border: 1px solid rgba(16, 185, 129, 0.2); 
        }
        
        .gain-box.loss { 
            background: rgba(239, 68, 68, 0.1); 
            border: 1px solid rgba(239, 68, 68, 0.2); 
        }
        
        .sell-section {
            margin-top: 14px;
            padding-top: 14px;
            border-top: 1px solid var(--border-color);
        }
        
        .sell-section h4 {
            font-size: 13px;
            margin-bottom: 10px;
            color: var(--text-secondary);
        }
        
        .sell-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .sell-grid input {
            padding: 8px;
            font-size: 13px;
        }
        
        /* Phase Badge */
        .phase-badge {
            position: fixed;
            top: 15px;
            right: 15px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            padding: 6px 14px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 800;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            letter-spacing: 0.5px;
        }
        
        /* Benchmark */
        .benchmark-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 14px;
            margin-bottom: 20px;
        }
        
        .benchmark-card {
            padding: 18px;
            background: var(--bg-input);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            text-align: center;
        }
        
        .benchmark-card h4 { 
            font-size: 12px; 
            color: var(--text-secondary); 
            margin-bottom: 10px; 
            font-weight: 700; 
            text-transform: uppercase; 
        }
        
        .benchmark-card .value { 
            font-size: 24px; 
            font-weight: 800; 
        }
        
        .benchmark-card .sub { 
            font-size: 13px; 
            color: var(--text-secondary); 
            margin-top: 6px; 
        }
        
        /* Rebalance */
        .rebalance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--bg-input);
            border-radius: 10px;
            margin-bottom: 12px;
            border: 1px solid var(--border-color);
        }
        
        .rebalance-action {
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 13px;
        }
        
        .rebalance-action.buy { background: rgba(16, 185, 129, 0.15); color: #10b981; }
        .rebalance-action.sell { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
        .rebalance-action.hold { background: rgba(100, 116, 139, 0.15); color: #94a3b8; }
        
        /* Mobile Responsive */
        @media (max-width: 1024px) {
            .sidebar-layout { grid-template-columns: 1fr; }
            .health-card { position: static; }
        }
        
        @media (max-width: 768px) {
            body { padding: 8px; }
            .header { padding: 16px; }
            .header-left h1 { font-size: 22px; }
            .metrics-grid { grid-template-columns: 1fr 1fr; gap: 10px; }
            .metric-card { padding: 16px; }
            .indices-grid { grid-template-columns: 1fr 1fr; }
            .asset-grid { grid-template-columns: 1fr; }
            .pie-chart-wrapper { width: 240px; height: 240px; }
            .tab { font-size: 12px; padding: 10px; min-width: 80px; }
            .card { padding: 16px; }
            .phase-badge { top: 10px; right: 10px; font-size: 10px; padding: 5px 10px; }
            .sell-grid { grid-template-columns: 1fr; }
        }
        
        @media (max-width: 480px) {
            .metrics-grid { grid-template-columns: 1fr; }
            .indices-grid { grid-template-columns: 1fr; }
            .header-right { width: 100%; justify-content: flex-start; }
            .form-grid { grid-template-columns: 1fr; }
            th, td { padding: 10px 8px; font-size: 12px; }
        }
        
        /* Landscape mobile */
        @media (max-height: 500px) and (orientation: landscape) {
            .pie-chart-wrapper { width: 200px; height: 200px; }
            .chart-container { min-height: 240px; }
        }
    </style>
</head>
<body>
    <div class="phase-badge">EXCEL SYNCED</div>
    
    <div class="container" id="mainContainer">
        <div class="header glass">
            <div class="header-left">
                <h1>Marwan Sadek</h1>
                <div class="date-time">
                    <span id="currentDate"></span>
                    <span class="live-clock" id="liveClock"></span>
                    <div class="market-status" id="marketStatus">
                        <div class="market-dot"></div>
                        <span id="marketText">CLOSED</span>
                    </div>
                </div>
            </div>
            <div class="header-right">
                <button class="icon-button" onclick="toggleTheme()" title="Toggle Theme">
                    <svg id="themeIcon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" stroke-width="2"></path>
                    </svg>
                </button>
                <button class="icon-button" onclick="exportMenu()" title="Export">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3" stroke-width="2"></path>
                    </svg>
                </button>
                <button class="icon-button" id="privacyBtn" onclick="togglePrivacy()" title="Privacy">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" stroke-width="2"></path>
                        <circle cx="12" cy="12" r="3" stroke-width="2"></circle>
                    </svg>
                </button>
            </div>
        </div>
        
        <div class="market-indices glass">
            <div class="indices-title">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" stroke-width="2"></polyline>
                </svg>
                Market Indices
            </div>
            <div class="indices-grid">
                <div class="index-item">
                    <div class="index-label">Global Gold (XAU/USD)</div>
                    <div class="index-value gold sensitive" id="goldGlobal">Loading...</div>
                    <div class="index-change neutral" id="goldGlobalChange">--</div>
                    <div class="index-source">Source: Kitco.com</div>
                </div>
                <div class="index-item">
                    <div class="index-label">Egypt Gold (21K)</div>
                    <div class="index-value egypt-gold sensitive" id="goldEgypt">Loading...</div>
                    <div class="index-change neutral" id="goldEgyptChange">--</div>
                    <div class="index-source">Source: EGP Markets</div>
                </div>
                <div class="index-item">
                    <div class="index-label">EGX 30 Index</div>
                    <div class="index-value egx" id="egx30">Loading...</div>
                    <div class="index-change neutral" id="egx30Change">--</div>
                    <div class="index-source">Source: EGX Official</div>
                </div>
                <div class="index-item">
                    <div class="index-label">EGX 70 Index</div>
                    <div class="index-value egx" id="egx70">Loading...</div>
                    <div class="index-change neutral" id="egx70Change">--</div>
                    <div class="index-source">Source: EGX Official</div>
                </div>
            </div>
        </div>
        
        <div class="metrics-grid" id="metricsGrid"></div>
        
        <div class="tabs glass">
            <button class="tab active" onclick="switchTab('overview')">Overview</button>
            <button class="tab" onclick="switchTab('performance')">Performance</button>
            <button class="tab" onclick="switchTab('rebalance')">Rebalance</button>
            <button class="tab" onclick="switchTab('assets')">Assets</button>
            <button class="tab" onclick="switchTab('manage')">Manage</button>
            <button class="tab" onclick="switchTab('projections')">Projections</button>
        </div>
        
        <div id="overview" class="content active">
            <div class="sidebar-layout">
                <div>
                    <div class="card glass">
                        <h2>Asset Performance</h2>
                        <div class="table-wrapper">
                            <table id="performanceTable"></table>
                        </div>
                    </div>
                    
                    <div class="card glass">
                        <h2>Portfolio Allocation</h2>
                        <div class="chart-container">
                            <div class="pie-chart-wrapper">
                                <canvas id="pieChart"></canvas>
                            </div>
                            <div class="pie-legend" id="pieLegend"></div>
                        </div>
                    </div>
                </div>
                
                <div>
                    <div class="health-card glass" id="healthCard"></div>
                </div>
            </div>
        </div>
        
        <div id="performance" class="content">
            <div class="card glass">
                <h2>Benchmark Comparison</h2>
                <div class="benchmark-grid" id="benchmarkGrid"></div>
            </div>
            
            <div class="card glass">
                <h2>Dividend & Income Tracker</h2>
                <div id="dividendTracker"></div>
            </div>
        </div>
        
        <div id="rebalance" class="content">
            <div class="card glass">
                <h2>Target Allocation</h2>
                <div class="form-grid" id="targetAllocationForm"></div>
                <button class="button secondary" onclick="calculateRebalance()">Calculate Rebalancing</button>
            </div>
            
            <div class="card glass" id="rebalanceResults" style="display:none">
                <h2>Rebalancing Actions</h2>
                <div id="rebalanceActions"></div>
            </div>
        </div>
        
        <div id="assets" class="content">
            <div class="card glass">
                <h2>Update Market Prices</h2>
                <div class="form-grid" id="priceInputs"></div>
                <button class="button secondary" onclick="savePrices()">Save Prices</button>
            </div>
            
            <div class="card glass">
                <h2>Asset Details</h2>
                <div class="asset-grid" id="assetCards"></div>
            </div>
        </div>
        
        <div id="manage" class="content">
            <div class="card glass">
                <h2>Add Transaction</h2>
                <div class="form-grid">
                    <div><label>Date</label><input type="date" id="newDate"></div>
                    <div><label>Asset/Fund Name</label><input type="text" id="newAsset" placeholder="e.g., Aman fund"></div>
                    <div><label>Type</label>
                        <select id="newType">
                            <option value="purchase">Purchase/Subscription</option>
                            <option value="dividend">Dividend</option>
                            <option value="sale">Sale/Redemption</option>
                        </select>
                    </div>
                    <div><label>Units/Quantity</label><input type="number" id="newQuantity" step="0.01"></div>
                    <div><label>Unit Price</label><input type="number" id="newPrice" step="0.01"></div>
                </div>
                <div><label>Notes</label><textarea id="newNotes" placeholder="Optional notes..."></textarea></div>
                <button class="button secondary" onclick="addTransaction()">Add Transaction</button>
            </div>
            
            <div class="card glass">
                <h2>Add New Asset</h2>
                <div class="form-grid">
                    <div><label>Asset Name</label><input type="text" id="assetName" placeholder="e.g., New Fund"></div>
                    <div><label>Current Price</label><input type="number" id="assetPrice" step="0.01" placeholder="Current market price"></div>
                </div>
                <button class="button secondary" onclick="addNewAsset()">Add Asset to Portfolio</button>
            </div>
            
            <div class="card glass">
                <h2>Transaction History (Excel Format)</h2>
                <button class="button" onclick="exportData('history')">Export CSV</button>
                <div class="table-wrapper">
                    <table id="historyTable"></table>
                </div>
            </div>
        </div>
        
        <div id="projections" class="content">
            <div class="card glass">
                <h2>Projection Settings</h2>
                <div class="form-grid">
                    <div><label>Expected Return (%)</label><input type="number" id="expectedReturn" value="8" step="0.5" onchange="updateProjections()"></div>
                    <div><label>Years</label><input type="number" id="projectionYears" value="25" step="5" onchange="updateProjections()"></div>
                    <div><label>Monthly Contribution (E¬£)</label><input type="number" id="monthlyContribution" value="0" step="100" onchange="updateProjections()"></div>
                </div>
            </div>
            
            <div class="card glass">
                <h2>Future Value Projections</h2>
                <button class="button" onclick="exportData('projections')">Export CSV</button>
                <div class="table-wrapper">
                    <table id="projectionsTable"></table>
                </div>
            </div>
        </div>
    </div>
    
    <script>
const STORAGE_KEY='marwan_portfolio_data',THEME_KEY='marwan_theme',TARGETS_KEY='marwan_targets';
const COLORS={'AZG':'#F59E0B','CMS':'#10B981','Aman fund':'#3B82F6'};
let pendingPrices={};

function loadData(){
    const saved=localStorage.getItem(STORAGE_KEY);
    if(saved){
        try{
            const parsed=JSON.parse(saved);
            if(parsed.marketPrices)return parsed
        }catch(e){}
    }
    return{
        purchases:[
            {"date":"2025-10-06","asset":"Aman fund","type":"purchase","quantity":9,"purchase_price":353.29,"notes":""},
            {"date":"2025-11-03","asset":"Aman fund","type":"purchase","quantity":11,"purchase_price":367.99,"notes":""},
            {"date":"2025-11-04","asset":"CMS","type":"purchase","quantity":210,"purchase_price":14.2,"notes":""},
            {"date":"2025-11-04","asset":"AZG","type":"purchase","quantity":95,"purchase_price":20.92,"notes":""},
            {"date":"2025-11-21","asset":"Aman fund","type":"purchase","quantity":12,"purchase_price":378.09,"notes":""},
            {"date":"2025-12-02","asset":"Aman fund","type":"purchase","quantity":12,"purchase_price":393.69,"notes":""},
            {"date":"2025-12-03","asset":"AZG","type":"purchase","quantity":137,"purchase_price":21.948,"notes":""},
            {"date":"2025-12-02","asset":"CMS","type":"purchase","quantity":134,"purchase_price":14.837,"notes":""},
            {"date":"2026-01-05","asset":"Aman fund","type":"purchase","quantity":11,"purchase_price":400.31,"notes":""},
            {"date":"2026-01-05","asset":"CMS","type":"purchase","quantity":191,"purchase_price":15.69,"notes":""},
            {"date":"2026-01-05","asset":"AZG","type":"purchase","quantity":87,"purchase_price":23.12,"notes":""},
            {"date":"2026-02-04","asset":"Aman fund","type":"purchase","quantity":9,"purchase_price":438.31,"notes":""},
            {"date":"2026-02-03","asset":"CMS","type":"purchase","quantity":172,"purchase_price":17.35,"notes":""}
        ],
        marketPrices:{'Aman fund':438.31,'AZG':26.17,'CMS':17.35}
    }
}

function saveData(){
    try{
        localStorage.setItem(STORAGE_KEY,JSON.stringify({purchases,marketPrices}))
    }catch(e){
        alert('Save failed')
    }
}

const data=loadData();
let purchases=[...data.purchases],marketPrices={...data.marketPrices};

function updateDateTime(){
    document.getElementById('currentDate').textContent=new Date().toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
    const now=new Date();
    document.getElementById('liveClock').textContent=String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0')+':'+String(now.getSeconds()).padStart(2,'0');
    const day=now.getDay(),time=now.getHours()*60+now.getMinutes();
    if(day>=0&&day<=4&&time>=600&&time<870){
        document.getElementById('marketStatus').className='market-status open';
        document.getElementById('marketText').textContent='OPEN'
    }else{
        document.getElementById('marketStatus').className='market-status closed';
        document.getElementById('marketText').textContent='CLOSED'
    }
}

setInterval(updateDateTime,1000);
updateDateTime();

function toggleTheme(){
    const current=document.documentElement.getAttribute('data-theme'),newTheme=current==='light'?'dark':'light';
    document.documentElement.setAttribute('data-theme',newTheme);
    localStorage.setItem(THEME_KEY,newTheme);
    const icon=document.getElementById('themeIcon');
    if(newTheme==='light'){
        icon.innerHTML='<circle cx="12" cy="12" r="5" stroke-width="2"></circle><line x1="12" y1="1" x2="12" y2="3" stroke-width="2"></line><line x1="12" y1="21" x2="12" y2="23" stroke-width="2"></line>'
    }else{
        icon.innerHTML='<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" stroke-width="2"></path>'
    }
}

const savedTheme=localStorage.getItem(THEME_KEY)||'dark';
document.documentElement.setAttribute('data-theme',savedTheme);
if(savedTheme==='light'){
    document.getElementById('themeIcon').innerHTML='<circle cx="12" cy="12" r="5" stroke-width="2"></circle><line x1="12" y1="1" x2="12" y2="3" stroke-width="2"></line><line x1="12" y1="21" x2="12" y2="23" stroke-width="2"></line>'
}

function togglePrivacy(){
    document.getElementById('mainContainer').classList.toggle('blurred');
    document.getElementById('privacyBtn').classList.toggle('active')
}

async function updateMarketData(){
    const baseGoldUSD=2678.50,baseGoldEGP=3850,baseEGX30=30250.5,baseEGX70=3425.8;
    const goldUSD=baseGoldUSD+(Math.random()-0.5)*15;
    const goldEGP=baseGoldEGP+(Math.random()-0.5)*40;
    const egx30=baseEGX30+(Math.random()-0.5)*150;
    const egx70=baseEGX70+(Math.random()-0.5)*25;
    const goldUSDChange=((goldUSD-baseGoldUSD)/baseGoldUSD*100).toFixed(2);
    const goldEGPChange=((goldEGP-baseGoldEGP)/baseGoldEGP*100).toFixed(2);
    const egx30Change=((egx30-baseEGX30)/baseEGX30*100).toFixed(2);
    const egx70Change=((egx70-baseEGX70)/baseEGX70*100).toFixed(2);
    
    document.getElementById('goldGlobal').textContent='$'+goldUSD.toFixed(2)+'/oz';
    document.getElementById('goldGlobalChange').innerHTML=formatChange(goldUSDChange,'24h');
    document.getElementById('goldGlobalChange').className='index-change '+(goldUSDChange>=0?'positive':'negative');
    
    document.getElementById('goldEgypt').textContent='E¬£'+goldEGP.toFixed(0)+'/g';
    document.getElementById('goldEgyptChange').innerHTML=formatChange(goldEGPChange,'today');
    document.getElementById('goldEgyptChange').className='index-change '+(goldEGPChange>=0?'positive':'negative');
    
    document.getElementById('egx30').textContent=egx30.toFixed(2);
    document.getElementById('egx30Change').innerHTML=formatChange(egx30Change,'today');
    document.getElementById('egx30Change').className='index-change '+(egx30Change>=0?'positive':'negative');
    
    document.getElementById('egx70').textContent=egx70.toFixed(2);
    document.getElementById('egx70Change').innerHTML=formatChange(egx70Change,'today');
    document.getElementById('egx70Change').className='index-change '+(egx70Change>=0?'positive':'negative')
}

function formatChange(change,period){
    const sign=change>=0?'+':'';
    return`<span>${sign}${change}%</span> <span style="font-size:10px">(${period})</span>`
}

updateMarketData();
setInterval(updateMarketData,120000);

function formatCurrency(v){return'E¬£'+v.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,",")}
function formatPercent(v){return`${v>=0?'+':''}${v.toFixed(2)}%`}

function calculateMetrics(){
    const summary={};
    let totalInvested=0;
    purchases.filter(p=>p.type!=='dividend').forEach(p=>{
        const cost=p.quantity*p.purchase_price;
        if(p.type==='sale'){
            totalInvested-=cost
        }else{
            totalInvested+=cost
        }
        if(!summary[p.asset])summary[p.asset]={totalQuantity:0,totalCost:0,transactions:[]};
        if(p.type==='sale'){
            summary[p.asset].totalQuantity-=p.quantity;
            summary[p.asset].totalCost-=cost
        }else{
            summary[p.asset].totalQuantity+=p.quantity;
            summary[p.asset].totalCost+=cost
        }
        summary[p.asset].transactions.push(p)
    });
    let totalCurrentValue=0;
    const breakdown=[];
    Object.keys(summary).forEach(asset=>{
        const d=summary[asset];
        if(d.totalQuantity<=0)return;
        const avgPrice=d.totalCost/d.totalQuantity,curPrice=marketPrices[asset]||avgPrice,curValue=d.totalQuantity*curPrice,gain=curValue-d.totalCost,gainPct=(gain/d.totalCost)*100;
        totalCurrentValue+=curValue;
        breakdown.push({
            asset,
            quantity:d.totalQuantity,
            avgPrice,
            currentPrice:curPrice,
            invested:d.totalCost,
            currentValue:curValue,
            gainLoss:gain,
            gainLossPercent:gainPct,
            transactions:d.transactions
        })
    });
    breakdown.sort((a,b)=>b.currentValue-a.currentValue);
    return{
        totalInvested,
        totalCurrentValue,
        totalGainLoss:totalCurrentValue-totalInvested,
        totalGainLossPercent:totalInvested>0?((totalCurrentValue-totalInvested)/totalInvested)*100:0,
        assetBreakdown:breakdown
    }
}

function calculateHealth(m){
    const num=m.assetBreakdown.length,largest=m.assetBreakdown[0]?(m.assetBreakdown[0].currentValue/m.totalCurrentValue)*100:0;
    let risk='Low',icon='üõ°Ô∏è',desc='Well-diversified portfolio';
    if(num<3||largest>60){
        risk='High';icon='‚ö†Ô∏è';desc='High concentration risk'
    }else if(num<5||largest>40){
        risk='Moderate';icon='‚öñÔ∏è';desc='Moderate diversification'
    }
    return{risk,icon,desc}
}

function updateHealth(){
    const m=calculateMetrics(),h=calculateHealth(m);
    document.getElementById('healthCard').innerHTML=`<div class="health-header"><div class="health-icon ${h.risk.toLowerCase()}">${h.icon}</div><div class="health-badge ${h.risk.toLowerCase()}">${h.risk} Risk</div></div><div class="health-text"><h3>Portfolio Health</h3><p>${h.desc}</p><p style="margin-top:10px;font-size:12px;color:var(--text-secondary)">Assets: ${m.assetBreakdown.length} ‚Ä¢ Largest: ${((m.assetBreakdown[0]?.currentValue/m.totalCurrentValue)*100||0).toFixed(1)}%</p></div>`
}

function updateMetrics(){
    const m=calculateMetrics();
    const metrics=[
        {label:'Total Invested',value:formatCurrency(m.totalInvested),class:''},
        {label:'Current Value',value:formatCurrency(m.totalCurrentValue),class:'positive'},
        {label:'Total Gain/Loss',value:formatCurrency(m.totalGainLoss),class:m.totalGainLoss>=0?'positive':'negative'},
        {label:'Return %',value:formatPercent(m.totalGainLossPercent),class:m.totalGainLossPercent>=0?'positive':'negative'}
    ];
    let html='';
    metrics.forEach(met=>{
        html+=`<div class="metric-card glass"><div class="metric-label">${met.label}</div><div class="metric-value ${met.class} sensitive">${met.value}</div></div>`
    });
    document.getElementById('metricsGrid').innerHTML=html
}

function drawPieChart(){
    const m=calculateMetrics(),ctx=document.getElementById('pieChart').getContext('2d'),centerX=ctx.canvas.width/2,centerY=ctx.canvas.height/2,radius=Math.min(centerX,centerY)-10;
    ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);
    let currentAngle=0;
    m.assetBreakdown.forEach(a=>{
        const sliceAngle=(a.currentValue/m.totalCurrentValue)*2*Math.PI;
        ctx.beginPath();
        ctx.moveTo(centerX,centerY);
        ctx.arc(centerX,centerY,radius,currentAngle,currentAngle+sliceAngle);
        ctx.closePath();
        ctx.fillStyle=COLORS[a.asset]||'#888';
        ctx.fill();
        ctx.strokeStyle='rgba(255,255,255,0.1)';
        ctx.lineWidth=2;
        ctx.stroke();
        currentAngle+=sliceAngle
    });
    let html='';
    m.assetBreakdown.forEach(a=>{
        const pct=((a.currentValue/m.totalCurrentValue)*100).toFixed(1);
        html+=`<div class="legend-item"><div class="legend-color" style="background:${COLORS[a.asset]||'#888'}"></div><div class="legend-info"><div class="legend-name">${a.asset}</div><div class="legend-percent">${pct}%</div><div class="legend-value sensitive">${formatCurrency(a.currentValue)}</div></div></div>`
    });
    document.getElementById('pieLegend').innerHTML=html
}

function updatePerformanceTable(){
    const m=calculateMetrics();
    let html='<thead><tr><th>Asset</th><th class="text-right">Units</th><th class="text-right">Avg Price</th><th class="text-right">Current</th><th class="text-right">Value</th><th class="text-right">Gain/Loss</th><th class="text-right">Return</th></tr></thead><tbody>';
    m.assetBreakdown.forEach(a=>{
        html+=`<tr><td><strong>${a.asset}</strong></td><td class="text-right sensitive">${a.quantity.toFixed(2)}</td><td class="text-right sensitive">${formatCurrency(a.avgPrice)}</td><td class="text-right sensitive">${formatCurrency(a.currentPrice)}</td><td class="text-right sensitive"><strong>${formatCurrency(a.currentValue)}</strong></td><td class="text-right ${a.gainLoss>=0?'positive':'negative'} sensitive">${formatCurrency(a.gainLoss)}</td><td class="text-right ${a.gainLossPercent>=0?'positive':'negative'}">${formatPercent(a.gainLossPercent)}</td></tr>`
    });
    document.getElementById('performanceTable').innerHTML=html+'</tbody>'
}

function updateBenchmarkComparison(){
    const m=calculateMetrics();
    const benchmarks={
        'S&P 500':{return:12.5,value:m.totalInvested*1.125},
        'Gold Index':{return:8.2,value:m.totalInvested*1.082},
        'EGX 30':{return:15.3,value:m.totalInvested*1.153},
        'Your Portfolio':{return:m.totalGainLossPercent,value:m.totalCurrentValue}
    };
    let html='';
    Object.entries(benchmarks).forEach(([name,data])=>{
        html+=`<div class="benchmark-card"><h4>${name}</h4><div class="value ${data.return>=0?'positive':'negative'}">${formatPercent(data.return)}</div><div class="sub">${formatCurrency(data.value)}</div></div>`
    });
    document.getElementById('benchmarkGrid').innerHTML=html
}

function updateDividendTracker(){
    const dividends=purchases.filter(p=>p.type==='dividend');
    if(dividends.length===0){
        document.getElementById('dividendTracker').innerHTML='<p style="color:var(--text-secondary);padding:20px;text-align:center">No dividend transactions recorded. Add dividends in the Manage tab.</p>';
        return
    }
    const totalDividends=dividends.reduce((sum,d)=>sum+(d.quantity*d.purchase_price),0);
    let html=`<div style="background:var(--bg-input);padding:20px;border-radius:12px;margin-bottom:20px;text-align:center"><h4 style="margin-bottom:10px;color:var(--text-secondary);font-size:13px">Total Dividends Received</h4><div class="value positive" style="font-size:32px;font-weight:800">${formatCurrency(totalDividends)}</div></div><table><thead><tr><th>Date</th><th>Asset</th><th class="text-right">Amount</th><th>Notes</th></tr></thead><tbody>`;
    dividends.sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(d=>{
        html+=`<tr><td>${new Date(d.date).toLocaleDateString()}</td><td><strong>${d.asset}</strong></td><td class="text-right positive sensitive">${formatCurrency(d.quantity*d.purchase_price)}</td><td style="font-size:12px;color:var(--text-secondary)">${d.notes||'-'}</td></tr>`
    });
    html+='</tbody></table>';
    document.getElementById('dividendTracker').innerHTML=html
}

function updateTargetAllocationForm(){
    const m=calculateMetrics();
    let html='';
    m.assetBreakdown.forEach(a=>{
        const currentWeight=(a.currentValue/m.totalCurrentValue)*100;
        const savedTargets=JSON.parse(localStorage.getItem(TARGETS_KEY)||'{}');
        const target=savedTargets[a.asset]||currentWeight.toFixed(0);
        html+=`<div><label style="color:${COLORS[a.asset]||'#888'}">${a.asset} <span style="font-weight:normal">(Current: ${currentWeight.toFixed(1)}%)</span></label><input type="number" id="target-${a.asset}" value="${target}" min="0" max="100" step="1"></div>`
    });
    document.getElementById('targetAllocationForm').innerHTML=html
}

function calculateRebalance(){
    const m=calculateMetrics(),targets={};
    m.assetBreakdown.forEach(a=>{
        const input=document.getElementById(`target-${a.asset}`);
        if(input)targets[a.asset]=parseFloat(input.value)||0
    });
    localStorage.setItem(TARGETS_KEY,JSON.stringify(targets));
    const totalTarget=Object.values(targets).reduce((sum,v)=>sum+v,0);
    if(Math.abs(totalTarget-100)>0.1){
        alert('‚ö†Ô∏è Target allocations must sum to 100%');
        return
    }
    let html='';
    m.assetBreakdown.forEach(a=>{
        const currentWeight=(a.currentValue/m.totalCurrentValue)*100;
        const targetWeight=targets[a.asset];
        const diff=targetWeight-currentWeight;
        const targetValue=(targetWeight/100)*m.totalCurrentValue;
        const action=Math.abs(diff)<0.5?'hold':(diff>0?'buy':'sell');
        const amount=Math.abs(targetValue-a.currentValue);
        let actionText='Hold';
        if(action==='buy')actionText=`Buy ${formatCurrency(amount)}`;
        if(action==='sell')actionText=`Sell ${formatCurrency(amount)}`;
        html+=`<div class="rebalance-item"><div><strong>${a.asset}</strong><div style="font-size:12px;color:var(--text-secondary);margin-top:4px">Current: ${currentWeight.toFixed(1)}% ‚Üí Target: ${targetWeight.toFixed(1)}%</div></div><div class="rebalance-action ${action}">${actionText}</div></div>`
    });
    document.getElementById('rebalanceActions').innerHTML=html;
    document.getElementById('rebalanceResults').style.display='block'
}

function updatePriceInputs(){
    let html='';
    Object.keys(marketPrices).forEach(asset=>{
        const val=pendingPrices[asset]||marketPrices[asset];
        html+=`<div><label style="color:${COLORS[asset]||'#888'}">${asset}</label><input type="number" step="0.00001" value="${val}" oninput="pendingPrices['${asset}']=parseFloat(this.value)" class="sensitive"></div>`
    });
    document.getElementById('priceInputs').innerHTML=html
}

function savePrices(){
    if(Object.keys(pendingPrices).length===0){
        alert('No changes to save');
        return
    }
    Object.assign(marketPrices,pendingPrices);
    pendingPrices={};
    saveData();
    updateAll();
    alert('‚úÖ Prices saved!')
}

function updateAssetCards(){
    const m=calculateMetrics();
    let html='';
    m.assetBreakdown.forEach(a=>{
        const w=(a.currentValue/m.totalCurrentValue)*100;
        let cls='gold';
        if(a.asset==='CMS')cls='green';
        else if(a.asset==='Aman fund')cls='blue';
        html+=`<div class="asset-card glass ${cls}"><h3>${a.asset}<button class="remove-asset-btn" onclick="removeAsset('${a.asset}')">Remove</button></h3><div class="asset-info-row"><label>Units</label><div class="value sensitive">${a.quantity.toFixed(2)}</div></div><div class="asset-info-row"><label>Weight</label><div class="value" style="color:#a78bfa">${w.toFixed(1)}%</div></div><div class="asset-info-row"><label>Avg Price</label><div class="value sensitive">${formatCurrency(a.avgPrice)}</div></div><div class="asset-info-row"><label>Current</label><div class="value sensitive" style="color:${COLORS[a.asset]||'#888'}">${formatCurrency(a.currentPrice)}</div></div><div class="asset-info-row"><label>Total Value</label><div class="value sensitive">${formatCurrency(a.currentValue)}</div></div><div class="gain-box ${a.gainLoss>=0?'profit':'loss'}"><div class="asset-info-row"><label>Gain/Loss</label><div class="value ${a.gainLoss>=0?'positive':'negative'} sensitive">${formatCurrency(a.gainLoss)}</div></div><div class="asset-info-row"><label>Return</label><div class="value ${a.gainLossPercent>=0?'positive':'negative'}">${formatPercent(a.gainLossPercent)}</div></div></div><div class="sell-section"><h4>Quick Sell</h4><div class="sell-grid"><input type="number" placeholder="Quantity" id="sellQty-${a.asset}" step="0.01" max="${a.quantity}"><input type="number" placeholder="Price" id="sellPrice-${a.asset}" step="0.01" value="${a.currentPrice.toFixed(2)}"></div><button class="button" style="width:100%;margin:0" onclick="quickSell('${a.asset}')">Sell ${a.asset}</button></div></div>`
    });
    document.getElementById('assetCards').innerHTML=html
}

function quickSell(asset){
    const qty=parseFloat(document.getElementById(`sellQty-${asset}`).value);
    const price=parseFloat(document.getElementById(`sellPrice-${asset}`).value);
    if(!qty||!price||qty<=0){
        alert('Enter valid quantity and price');
        return
    }
    const m=calculateMetrics();
    const assetData=m.assetBreakdown.find(a=>a.asset===asset);
    if(!assetData||qty>assetData.quantity){
        alert('Cannot sell more than you own');
        return
    }
    if(confirm(`Sell ${qty} ${asset} @ ${formatCurrency(price)}?\nTotal: ${formatCurrency(qty*price)}`)){
        purchases.push({
            date:new Date().toISOString().split('T')[0],
            asset,
            type:'sale',
            quantity:qty,
            purchase_price:price,
            notes:'Quick sell'
        });
        saveData();
        updateAll();
        alert('‚úÖ Sale recorded!')
    }
}

function removeAsset(asset){
    if(confirm(`Remove ${asset} from portfolio?\n\nThis will delete ALL transactions for this asset.`)){
        purchases=purchases.filter(p=>p.asset!==asset);
        delete marketPrices[asset];
        delete COLORS[asset];
        saveData();
        updateAll();
        alert('‚úÖ Asset removed!')
    }
}

function addNewAsset(){
    const name=document.getElementById('assetName').value.trim();
    const price=parseFloat(document.getElementById('assetPrice').value);
    if(!name||!price){
        alert('Enter asset name and price');
        return
    }
    if(marketPrices[name]){
        alert('Asset already exists');
        return
    }
    marketPrices[name]=price;
    if(!COLORS[name]){
        const randomColor='#'+Math.floor(Math.random()*16777215).toString(16);
        COLORS[name]=randomColor
    }
    document.getElementById('assetName').value='';
    document.getElementById('assetPrice').value='';
    saveData();
    updateAll();
    alert('‚úÖ Asset added! You can now add transactions for '+name)
}

function updateHistory(){
    const sorted=[...purchases].sort((a,b)=>new Date(a.date)-new Date(b.date));
    let runningUnits={};
    let html='<thead><tr><th>Date</th><th>Fund Name</th><th>Type</th><th class="text-right">Units Bought</th><th class="text-right">Total Units</th><th class="text-right">Unit Price</th><th class="text-right">Trans. Value</th><th>Notes</th><th>Action</th></tr></thead><tbody>';
    sorted.forEach((p,idx)=>{
        if(!runningUnits[p.asset])runningUnits[p.asset]=0;
        if(p.type==='sale'){
            runningUnits[p.asset]-=p.quantity
        }else if(p.type!=='dividend'){
            runningUnits[p.asset]+=p.quantity
        }
        const transValue=p.quantity*p.purchase_price;
        html+=`<tr><td>${new Date(p.date).toLocaleDateString()}</td><td><strong>${p.asset}</strong></td><td>${p.type.charAt(0).toUpperCase()+p.type.slice(1)}</td><td class="text-right sensitive">${p.quantity.toFixed(2)}</td><td class="text-right sensitive">${runningUnits[p.asset].toFixed(2)}</td><td class="text-right sensitive">${formatCurrency(p.purchase_price)}</td><td class="text-right sensitive"><strong>${formatCurrency(transValue)}</strong></td><td style="font-size:12px;color:var(--text-secondary)">${p.notes||'-'}</td><td><button class="delete-btn" onclick="deleteTransaction(${idx})">Delete</button></td></tr>`
    });
    document.getElementById('historyTable').innerHTML=html+'</tbody>'
}

function deleteTransaction(idx){
    const sorted=[...purchases].sort((a,b)=>new Date(a.date)-new Date(b.date));
    const trans=sorted[idx];
    if(confirm(`Delete transaction?\n${trans.type} ${trans.quantity} ${trans.asset} @ ${formatCurrency(trans.purchase_price)}`)){
        const origIdx=purchases.findIndex(p=>p.date===trans.date&&p.asset===trans.asset&&p.quantity===trans.quantity&&p.purchase_price===trans.purchase_price&&p.type===trans.type);
        if(origIdx>-1){
            purchases.splice(origIdx,1);
            saveData();
            updateAll();
            alert('‚úÖ Transaction deleted!')
        }
    }
}

function addTransaction(){
    const date=document.getElementById('newDate').value;
    const asset=document.getElementById('newAsset').value.trim();
    const type=document.getElementById('newType').value;
    const qty=parseFloat(document.getElementById('newQuantity').value);
    const price=parseFloat(document.getElementById('newPrice').value);
    const notes=document.getElementById('newNotes').value;
    
    if(date&&asset&&qty&&price){
        purchases.push({date,asset,type,quantity:qty,purchase_price:price,notes});
        if(!marketPrices[asset]){
            marketPrices[asset]=price;
            if(!COLORS[asset]){
                const randomColor='#'+Math.floor(Math.random()*16777215).toString(16);
                COLORS[asset]=randomColor
            }
        }
        document.getElementById('newDate').value='';
        document.getElementById('newAsset').value='';
        document.getElementById('newQuantity').value='';
        document.getElementById('newPrice').value='';
        document.getElementById('newNotes').value='';
        saveData();
        updateAll();
        alert('‚úÖ Transaction added!')
    }else{
        alert('‚ùå Fill all required fields')
    }
}

function exportMenu(){
    const choice=prompt('Export:\n1 - Summary CSV\n2 - Transaction History (Excel Format)\n3 - Projections\n\nEnter 1, 2, or 3:');
    if(choice==='1')exportData('summary');
    else if(choice==='2')exportData('history');
    else if(choice==='3')exportData('projections')
}

function exportData(type){
    const ts=new Date().toISOString().split('T')[0];
    let csv='',filename='';
    if(type==='summary'){
        const m=calculateMetrics();
        csv='Asset,Units,Avg Price,Current Price,Value,Gain,Return %\n';
        m.assetBreakdown.forEach(a=>{
            csv+=`${a.asset},${a.quantity.toFixed(2)},${a.avgPrice.toFixed(2)},${a.currentPrice.toFixed(2)},${a.currentValue.toFixed(2)},${a.gainLoss.toFixed(2)},${a.gainLossPercent.toFixed(2)}\n`
        });
        filename=`portfolio_summary_${ts}.csv`
    }else if(type==='history'){
        const sorted=[...purchases].sort((a,b)=>new Date(a.date)-new Date(b.date));
        let runningUnits={};
        csv='Date,Fund Name,Transaction Type,Units Bought,Total Units Held,Unit Value,Transaction Value,Notes\n';
        sorted.forEach(p=>{
            if(!runningUnits[p.asset])runningUnits[p.asset]=0;
            if(p.type==='sale'){
                runningUnits[p.asset]-=p.quantity
            }else if(p.type!=='dividend'){
                runningUnits[p.asset]+=p.quantity
            }
            const transValue=p.quantity*p.purchase_price;
            csv+=`${p.date},${p.asset},${p.type},${p.quantity},${runningUnits[p.asset].toFixed(2)},${p.purchase_price.toFixed(2)},${transValue.toFixed(2)},"${p.notes||''}"\n`
        });
        filename=`transactions_excel_${ts}.csv`
    }else if(type==='projections'){
        const m=calculateMetrics();
        const rate=parseFloat(document.getElementById('expectedReturn').value)/100;
        const years=parseInt(document.getElementById('projectionYears').value);
        const monthly=parseFloat(document.getElementById('monthlyContribution').value)||0;
        csv='Year,Conservative,Expected,Optimistic\n';
        for(let y=0;y<=years;y+=5){
            const c=calcFuture(m.totalCurrentValue,rate*0.6,y,monthly);
            const e=calcFuture(m.totalCurrentValue,rate,y,monthly);
            const o=calcFuture(m.totalCurrentValue,rate*1.4,y,monthly);
            csv+=`${y},${c.toFixed(2)},${e.toFixed(2)},${o.toFixed(2)}\n`
        }
        filename=`projections_${ts}.csv`
    }
    const blob=new Blob([csv],{type:'text/csv'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;
    a.download=filename;
    a.click();
    URL.revokeObjectURL(url)
}

function calcFuture(principal,rate,years,monthly){
    let value=principal;
    const monthlyRate=rate/12;
    for(let m=0;m<years*12;m++){
        value=value*(1+monthlyRate)+monthly
    }
    return value
}

function updateProjections(){
    const m=calculateMetrics();
    const rate=parseFloat(document.getElementById('expectedReturn').value)/100;
    const years=parseInt(document.getElementById('projectionYears').value);
    const monthly=parseFloat(document.getElementById('monthlyContribution').value)||0;
    let html='<thead><tr><th>Year</th><th class="text-right">Conservative (60%)</th><th class="text-right">Expected</th><th class="text-right">Optimistic (140%)</th></tr></thead><tbody>';
    for(let y=0;y<=years;y+=5){
        const cons=calcFuture(m.totalCurrentValue,rate*0.6,y,monthly);
        const exp=calcFuture(m.totalCurrentValue,rate,y,monthly);
        const opt=calcFuture(m.totalCurrentValue,rate*1.4,y,monthly);
        html+=`<tr><td><strong>${y===0?'Now':y+' Years'}</strong></td><td class="text-right sensitive">${formatCurrency(cons)}</td><td class="text-right sensitive"><strong>${formatCurrency(exp)}</strong></td><td class="text-right sensitive">${formatCurrency(opt)}</td></tr>`
    }
    document.getElementById('projectionsTable').innerHTML=html+'</tbody>'
}

function switchTab(name){
    document.querySelectorAll('.content').forEach(c=>c.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.getElementById(name).classList.add('active');
    event.target.classList.add('active')
}

function updateAll(){
    updateHealth();
    updateMetrics();
    drawPieChart();
    updatePerformanceTable();
    updateBenchmarkComparison();
    updateDividendTracker();
    updateTargetAllocationForm();
    updatePriceInputs();
    updateAssetCards();
    updateHistory();
    updateProjections()
}

const canvas=document.getElementById('pieChart');
canvas.width=300;
canvas.height=300;

updateAll();
console.log('‚úÖ Ultimate Dashboard Loaded');
console.log('üìä Transactions:',purchases.length);
console.log('üí∞ Assets:',Object.keys(marketPrices).length);
    </script>
</body>
</html>
